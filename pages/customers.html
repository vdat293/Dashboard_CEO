<!doctype html>
<html lang="vi">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Quản Lý Khách Hàng | Dashboard CEO</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#007bff" media="(prefers-color-scheme: light)" />

    <!-- Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" />

    <!-- OverlayScrollbars -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css" crossorigin="anonymous" />

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" crossorigin="anonymous" />

    <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css" />

    <!-- ApexCharts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css" integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../assets/css/variables.css" />
    <link rel="stylesheet" href="../assets/css/style.css" />
  </head>

  <body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">

      <!-- Content Wrapper -->
      <div class="content-wrapper">
        <div class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1 class="m-0">Quản Lý Khách Hàng</h1>
              </div>
              <div class="col-sm-6">
                <div class="float-sm-right">
                  <select id="location-selector" class="form-control location-filter" style="width: auto; display: inline-block; min-width: 200px;">
                    <option value="">Tất cả cơ sở (Tổng hợp)</option>
                    <option value="HN">Hà Nội</option>
                    <option value="HCM">TP. Hồ Chí Minh</option>
                    <option value="DN">Đà Nẵng</option>
                    <option value="HP">Hải Phòng</option>
                    <option value="CT">Cần Thơ</option>
                    <option value="NT">Nha Trang</option>
                    <option value="VT">Vũng Tàu</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main content -->
        <section class="content">
          <div class="container-fluid">

            <!-- Thống kê khách hàng -->
            <div class="row">
              <div class="col-lg-3 col-6">
                <div class="info-box">
                  <span class="info-box-icon bg-gradient-info elevation-1">
                    <i class="bi bi-person-plus"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Khách hàng mới tháng này</span>
                    <span class="info-box-number" id="kpi-new-customers">
                      1,806
                      <small class="trend-up">
                        <i class="bi bi-arrow-up"></i> 4.8%
                      </small>
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-lg-3 col-6">
                <div class="info-box">
                  <span class="info-box-icon bg-gradient-success elevation-1">
                    <i class="bi bi-people-fill"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Tổng khách hàng tích lũy</span>
                    <span class="info-box-number" id="kpi-total-customers">
                      84,617
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-lg-3 col-6">
                <div class="info-box">
                  <span class="info-box-icon bg-gradient-warning elevation-1">
                    <i class="bi bi-star"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Khách hàng VIP</span>
                    <span class="info-box-number" id="kpi-vip">
                      423
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-lg-3 col-6">
                <div class="info-box">
                  <span class="info-box-icon bg-gradient-primary elevation-1">
                    <i class="bi bi-cart"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Trung bình đơn/KH</span>
                    <span class="info-box-number" id="kpi-orders-per-customer">
                      3.31
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Biểu đồ -->
            <div class="row">
              <div class="col-lg-8">
                <div class="card">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-graph-up mr-2"></i>
                      <span id="chart-title">Phân tích xu hướng khách hàng (Tổng hợp)</span>
                    </h3>
                    <div class="card-tools">
                      <small class="text-muted">Doanh thu & Khách hàng mới</small>
                    </div>
                  </div>
                  <div class="card-body">
                    <div id="customer-trend-chart" style="height: 400px;"></div>
                  </div>
                </div>
              </div>

              <div class="col-lg-4">
                <div class="card">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-megaphone mr-2"></i>
                      Nguồn khách hàng mới
                    </h3>
                    <div class="card-tools">
                      <small class="text-muted">Kênh marketing hiệu quả nhất</small>
                    </div>
                  </div>
                  <div class="card-body">
                    <div id="customer-distribution-chart" style="height: 400px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Phân tích chi tiết -->
            <div class="row">
              <div class="col-lg-6">
                <div class="card">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-graph-up mr-2"></i>
                      Xu hướng Marketing: TikTok vs Facebook
                    </h3>
                    <div class="card-tools">
                      <small class="text-muted">Khách hàng mới theo tháng</small>
                    </div>
                  </div>
                  <div class="card-body">
                    <div id="customers-orders-chart" style="height: 350px;"></div>
                  </div>
                </div>
              </div>

              <div class="col-lg-6">
                <div class="card">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-cash-coin mr-2"></i>
                      Hiệu quả Marketing - ROI theo kênh
                    </h3>
                    <div class="card-tools">
                      <small class="text-muted">LTV/CAC Ratio</small>
                    </div>
                  </div>
                  <div class="card-body">
                    <div id="customer-segment-chart" style="height: 350px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Danh sách khách hàng VIP -->
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header border-0">
                    <div class="d-flex justify-content-between align-items-center">
                      <h3 class="card-title">
                        <i class="bi bi-star-fill text-warning mr-2"></i>
                        Top 10 Khách Hàng VIP
                      </h3>
                      <div>
                        <button type="button" class="btn btn-sm btn-outline-primary">
                          <i class="bi bi-funnel"></i> Lọc
                        </button>
                        <button type="button" class="btn btn-sm btn-primary">
                          <i class="bi bi-plus-circle"></i> Thêm khách hàng
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body table-responsive p-0">
                    <table class="table table-hover">
                      <thead class="bg-light">
                        <tr>
                          <th>STT</th>
                          <th>ID</th>
                          <th>Tên khách hàng</th>
                          <th>Email</th>
                          <th>Điện thoại</th>
                          <th class="text-right">Tổng chi tiêu</th>
                          <th class="text-center">Đơn hàng</th>
                          <th class="text-center">Hạng</th>
                          <th class="text-center">Trạng thái</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td><strong>1</strong></td>
                          <td><span class="badge badge-light">#KH00156</span></td>
                          <td>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-person-circle text-primary mr-2" style="font-size: 1.5rem;"></i>
                              <strong>Nguyễn Văn Minh</strong>
                            </div>
                          </td>
                          <td><small>minh.nguyen@techcorp.vn</small></td>
                          <td><small>0901234567</small></td>
                          <td class="text-right"><span class="text-success"><strong>485 triệu</strong></span></td>
                          <td class="text-center"><span class="badge badge-info">142</span></td>
                          <td class="text-center"><span class="badge badge-warning"><i class="bi bi-star-fill"></i> Diamond</span></td>
                          <td class="text-center"><span class="badge badge-success">Hoạt động</span></td>
                        </tr>
                        <tr>
                          <td><strong>2</strong></td>
                          <td><span class="badge badge-light">#KH00089</span></td>
                          <td>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-person-circle text-primary mr-2" style="font-size: 1.5rem;"></i>
                              <strong>Trần Thị Hương</strong>
                            </div>
                          </td>
                          <td><small>huong.tran@bizgroup.com</small></td>
                          <td><small>0912345678</small></td>
                          <td class="text-right"><span class="text-success"><strong>428 triệu</strong></span></td>
                          <td class="text-center"><span class="badge badge-info">118</span></td>
                          <td class="text-center"><span class="badge badge-warning"><i class="bi bi-star-fill"></i> Diamond</span></td>
                          <td class="text-center"><span class="badge badge-success">Hoạt động</span></td>
                        </tr>
                        <tr>
                          <td><strong>3</strong></td>
                          <td><span class="badge badge-light">#KH00234</span></td>
                          <td>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-person-circle text-primary mr-2" style="font-size: 1.5rem;"></i>
                              <strong>Lê Hoàng Nam</strong>
                            </div>
                          </td>
                          <td><small>nam.le.hoang@gmail.com</small></td>
                          <td><small>0923456789</small></td>
                          <td class="text-right"><span class="text-success"><strong>375 triệu</strong></span></td>
                          <td class="text-center"><span class="badge badge-info">96</span></td>
                          <td class="text-center"><span class="badge badge-info"><i class="bi bi-star"></i> Platinum</span></td>
                          <td class="text-center"><span class="badge badge-success">Hoạt động</span></td>
                        </tr>
                        <tr>
                          <td><strong>4</strong></td>
                          <td><span class="badge badge-light">#KH00512</span></td>
                          <td>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-person-circle text-primary mr-2" style="font-size: 1.5rem;"></i>
                              <strong>Phạm Minh Châu</strong>
                            </div>
                          </td>
                          <td><small>chau.pham@outlook.com</small></td>
                          <td><small>0934567890</small></td>
                          <td class="text-right"><span class="text-success"><strong>328 triệu</strong></span></td>
                          <td class="text-center"><span class="badge badge-info">84</span></td>
                          <td class="text-center"><span class="badge badge-info"><i class="bi bi-star"></i> Platinum</span></td>
                          <td class="text-center"><span class="badge badge-success">Hoạt động</span></td>
                        </tr>
                        <tr>
                          <td><strong>5</strong></td>
                          <td><span class="badge badge-light">#KH00678</span></td>
                          <td>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-person-circle text-primary mr-2" style="font-size: 1.5rem;"></i>
                              <strong>Võ Thành Đạt</strong>
                            </div>
                          </td>
                          <td><small>dat.vo@techsolutions.vn</small></td>
                          <td><small>0945678901</small></td>
                          <td class="text-right"><span class="text-success"><strong>295 triệu</strong></span></td>
                          <td class="text-center"><span class="badge badge-info">72</span></td>
                          <td class="text-center"><span class="badge badge-info"><i class="bi bi-star"></i> Platinum</span></td>
                          <td class="text-center"><span class="badge badge-warning">Chưa hoạt động 30 ngày</span></td>
                        </tr>
                        <tr>
                          <td><strong>6</strong></td>
                          <td><span class="badge badge-light">#KH00891</span></td>
                          <td>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-person-circle text-primary mr-2" style="font-size: 1.5rem;"></i>
                              <strong>Đặng Thị Mai</strong>
                            </div>
                          </td>
                          <td><small>mai.dang@gmail.com</small></td>
                          <td><small>0956789012</small></td>
                          <td class="text-right"><span class="text-success"><strong>268 triệu</strong></span></td>
                          <td class="text-center"><span class="badge badge-info">65</span></td>
                          <td class="text-center"><span class="badge badge-primary"><i class="bi bi-star"></i> Gold</span></td>
                          <td class="text-center"><span class="badge badge-success">Hoạt động</span></td>
                        </tr>
                        <tr>
                          <td><strong>7</strong></td>
                          <td><span class="badge badge-light">#KH01023</span></td>
                          <td>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-person-circle text-primary mr-2" style="font-size: 1.5rem;"></i>
                              <strong>Bùi Quang Huy</strong>
                            </div>
                          </td>
                          <td><small>huy.bui@startup.io</small></td>
                          <td><small>0967890123</small></td>
                          <td class="text-right"><span class="text-success"><strong>242 triệu</strong></span></td>
                          <td class="text-center"><span class="badge badge-info">58</span></td>
                          <td class="text-center"><span class="badge badge-primary"><i class="bi bi-star"></i> Gold</span></td>
                          <td class="text-center"><span class="badge badge-success">Hoạt động</span></td>
                        </tr>
                        <tr>
                          <td><strong>8</strong></td>
                          <td><span class="badge badge-light">#KH01156</span></td>
                          <td>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-person-circle text-primary mr-2" style="font-size: 1.5rem;"></i>
                              <strong>Hoàng Thu Thảo</strong>
                            </div>
                          </td>
                          <td><small>thao.hoang@company.vn</small></td>
                          <td><small>0978901234</small></td>
                          <td class="text-right"><span class="text-success"><strong>215 triệu</strong></span></td>
                          <td class="text-center"><span class="badge badge-info">51</span></td>
                          <td class="text-center"><span class="badge badge-primary"><i class="bi bi-star"></i> Gold</span></td>
                          <td class="text-center"><span class="badge badge-success">Hoạt động</span></td>
                        </tr>
                        <tr>
                          <td><strong>9</strong></td>
                          <td><span class="badge badge-light">#KH01289</span></td>
                          <td>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-person-circle text-primary mr-2" style="font-size: 1.5rem;"></i>
                              <strong>Dương Văn Long</strong>
                            </div>
                          </td>
                          <td><small>long.duong@enterprise.com</small></td>
                          <td><small>0989012345</small></td>
                          <td class="text-right"><span class="text-success"><strong>188 triệu</strong></span></td>
                          <td class="text-center"><span class="badge badge-info">45</span></td>
                          <td class="text-center"><span class="badge badge-secondary"><i class="bi bi-star"></i> Silver</span></td>
                          <td class="text-center"><span class="badge badge-success">Hoạt động</span></td>
                        </tr>
                        <tr>
                          <td><strong>10</strong></td>
                          <td><span class="badge badge-light">#KH01445</span></td>
                          <td>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-person-circle text-primary mr-2" style="font-size: 1.5rem;"></i>
                              <strong>Trương Thị Lan</strong>
                            </div>
                          </td>
                          <td><small>lan.truong@yahoo.com</small></td>
                          <td><small>0990123456</small></td>
                          <td class="text-right"><span class="text-success"><strong>165 triệu</strong></span></td>
                          <td class="text-center"><span class="badge badge-info">39</span></td>
                          <td class="text-center"><span class="badge badge-secondary"><i class="bi bi-star"></i> Silver</span></td>
                          <td class="text-center"><span class="badge badge-success">Hoạt động</span></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="card-footer clearfix">
                    <ul class="pagination pagination-sm m-0 float-end">
                      <li class="page-item"><a class="page-link" href="#">«</a></li>
                      <li class="page-item active"><a class="page-link" href="#">1</a></li>
                      <li class="page-item"><a class="page-link" href="#">2</a></li>
                      <li class="page-item"><a class="page-link" href="#">3</a></li>
                      <li class="page-item"><a class="page-link" href="#">»</a></li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </section>
      </div>
    </div>

    <!-- Scripts -->
    <!-- jQuery (required for AdminLTE and chart interactions) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js" integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8=" crossorigin="anonymous"></script>

    <!-- Load Auth & Data -->
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/data.js"></script>

    <!-- Authentication Check -->
    <script>
      // Kiểm tra đăng nhập khi load trang
      requireAuth();

      // Hiển thị thông tin user
      displayUserInfo();

      // Cập nhật badge location cho user không phải CEO
      const user = getCurrentUser();
      if (user && user.role !== 'ceo') {
        const locationName = getLocationName(user.locations[0]);
        const badge = document.getElementById('user-location-badge');
        if (badge) {
          badge.textContent = locationName;
        }
      }
    </script>

    <script>
      // State management
      let currentLocation = '';

      // Chart instances
      let customerTrendChart, distributionChart, customersOrdersChart, segmentChart;

      // Initialize page
      $(document).ready(function() {
        initCharts();
        updateDashboard();

        // Event listeners
        $('#location-selector').on('change', function() {
          currentLocation = $(this).val();
          updateDashboard();
        });
      });

      // Initialize all charts
      function initCharts() {
        // Customer trend chart - Combo Chart (Column + Line)
        customerTrendChart = new ApexCharts(document.querySelector('#customer-trend-chart'), {
          series: [],
          chart: {
            height: 400,
            type: 'line',
            toolbar: { show: true },
            zoom: { enabled: true }
          },
          colors: ['#28a745', '#007bff'],
          dataLabels: { enabled: false },
          stroke: {
            curve: 'smooth',
            width: [0, 3] // 0 for column, 3 for line
          },
          plotOptions: {
            bar: {
              columnWidth: '50%'
            }
          },
          xaxis: {
            categories: monthLabelsShort,
            title: { text: 'Tháng' }
          },
          yaxis: [{
            title: { text: 'Doanh thu (triệu VNĐ)' },
            labels: {
              formatter: val => formatNumber(val)
            }
          }, {
            opposite: true,
            title: { text: 'Số khách hàng mới' },
            labels: {
              formatter: val => formatNumber(val)
            }
          }],
          tooltip: {
            shared: true,
            intersect: false,
            y: [{
              formatter: val => formatChartValue(val)
            }, {
              formatter: val => formatNumber(val) + ' khách hàng'
            }]
          },
          legend: {
            position: 'top',
            horizontalAlign: 'left'
          }
        });
        customerTrendChart.render();

        // Distribution chart
        distributionChart = new ApexCharts(document.querySelector('#customer-distribution-chart'), {
          series: [],
          chart: { type: 'donut', height: 400 },
          labels: [],
          colors: ['#007bff', '#28a745', '#17a2b8', '#ffc107', '#6f42c1', '#fd7e14', '#20c997'],
          legend: { position: 'bottom' },
          plotOptions: {
            pie: {
              donut: {
                labels: {
                  show: true,
                  total: {
                    show: true,
                    label: 'Tổng',
                    formatter: (w) => {
                      const total = sumArray(w.globals.seriesTotals);
                      return formatNumber(total);
                    }
                  }
                }
              }
            }
          },
          tooltip: {
            y: {
              formatter: val => formatNumber(val) + ' khách hàng'
            }
          }
        });
        distributionChart.render();

        // Customers & Orders chart
        customersOrdersChart = new ApexCharts(document.querySelector('#customers-orders-chart'), {
          series: [],
          chart: {
            type: 'line',
            height: 350,
            toolbar: { show: false }
          },
          colors: ['#007bff', '#28a745'],
          stroke: { curve: 'smooth', width: 3 },
          markers: { size: 5 },
          xaxis: { categories: monthLabelsShort },
          yaxis: [{
            title: { text: 'Khách hàng' },
            labels: {
              formatter: val => formatNumber(val)
            }
          }, {
            opposite: true,
            title: { text: 'Đơn hàng' },
            labels: {
              formatter: val => formatNumber(val)
            }
          }],
          tooltip: {
            y: {
              formatter: val => formatNumber(val)
            }
          },
          legend: { position: 'top' }
        });
        customersOrdersChart.render();

        // Marketing ROI chart (horizontal bar)
        segmentChart = new ApexCharts(document.querySelector('#customer-segment-chart'), {
          series: [],
          chart: {
            type: 'bar',
            height: 350,
            toolbar: { show: false }
          },
          plotOptions: {
            bar: {
              horizontal: true,
              distributed: true
            }
          },
          dataLabels: {
            enabled: true
          },
          legend: { show: false }
        });
        segmentChart.render();
      }

      // Update dashboard
      function updateDashboard() {
        updateKPIs();
        updateCustomerTrendChart();
        updateDistributionChart();
        updateCustomersOrdersChart();
        updateSegmentChart();
      }

      // Update KPIs
      function updateKPIs() {
        const currentMonth = getCurrentMonth();
        let data, title;

        if (currentLocation === '') {
          // All locations
          data = businessDataByMonth[2025];
          title = 'Tất cả cơ sở';
        } else {
          // Single location
          data = locationData[currentLocation];
          const loc = locations.find(l => l.id === currentLocation);
          title = loc.name;
        }

        // Calculate totals
        const monthlyNewCustomers = data.newCustomers[currentMonth];
        const totalCumulativeCustomers = data.cumulativeCustomers[currentMonth]; // Tổng KH tích lũy đến tháng hiện tại
        const monthlyOrders = data.orders[currentMonth];
        const monthlyCustomers = data.customers[currentMonth];
        const ordersPerCustomer = monthlyOrders / monthlyCustomers;

        // YoY growth for new customers
        const lastYearData = currentLocation === '' ? businessDataByMonth[2024] : null;
        let yoyGrowth = 0;
        if (lastYearData) {
          const lastYearNewCustomers = lastYearData.newCustomers[currentMonth];
          yoyGrowth = ((monthlyNewCustomers - lastYearNewCustomers) / lastYearNewCustomers * 100);
        } else {
          yoyGrowth = 4.8; // Default for single location
        }

        // VIP customers (estimated 0.5% of cumulative total - more realistic)
        const vipCustomers = Math.round(totalCumulativeCustomers * 0.005);

        // Update KPIs
        $('#kpi-new-customers').html(`
          ${monthlyNewCustomers.toLocaleString()}
          <small class="${yoyGrowth >= 0 ? 'trend-up' : 'trend-down'}">
            <i class="bi bi-arrow-${yoyGrowth >= 0 ? 'up' : 'down'}"></i> ${Math.abs(yoyGrowth).toFixed(1)}%
          </small>
        `);
        $('#kpi-total-customers').text(totalCumulativeCustomers.toLocaleString());
        $('#kpi-vip').text(vipCustomers.toLocaleString());
        $('#kpi-orders-per-customer').text(ordersPerCustomer.toFixed(2));

        // Update chart title
        $('#chart-title').text(`Phân tích xu hướng khách hàng (${title})`);
      }

      // Update customer trend chart - Combo Chart (Revenue + New Customers)
      function updateCustomerTrendChart() {
        let series = [];

        if (currentLocation === '') {
          // All locations - Column: Revenue, Line: New customers
          series = [
            {
              name: 'Doanh thu',
              type: 'column',
              data: businessDataByMonth[2025].revenue
            },
            {
              name: 'Khách hàng mới',
              type: 'line',
              data: businessDataByMonth[2025].newCustomers
            }
          ];
        } else {
          // Single location - Column: Revenue, Line: New customers
          series = [
            {
              name: 'Doanh thu',
              type: 'column',
              data: locationData[currentLocation].revenue
            },
            {
              name: 'Khách hàng mới',
              type: 'line',
              data: locationData[currentLocation].newCustomers
            }
          ];
        }

        customerTrendChart.updateSeries(series);
      }

      // Update distribution chart - Customer Acquisition Channels
      function updateDistributionChart() {
        // Hiển thị nguồn khách hàng theo kênh marketing
        const channels = customerAcquisitionChannels.channels.filter(ch => ch.id !== 'direct');
        const distribution = customerAcquisitionChannels.distribution;

        const labels = channels.map(ch => ch.name);
        const values = channels.map(ch => distribution[ch.id]);
        const colors = channels.map(ch => ch.color);

        distributionChart.updateOptions({
          chart: { type: 'donut' },
          series: values,
          labels: labels,
          colors: colors,
          legend: {
            position: 'bottom',
            fontSize: '13px'
          },
          plotOptions: {
            pie: {
              donut: {
                labels: {
                  show: true,
                  total: {
                    show: true,
                    label: 'Tổng',
                    formatter: () => '100%'
                  }
                }
              }
            }
          },
          tooltip: {
            y: {
              formatter: (val) => val + '%'
            }
          }
        });
      }

      // Update Customers & Orders chart - Marketing Trends (TikTok vs Facebook)
      function updateCustomersOrdersChart() {
        // Hiển thị xu hướng TikTok vs Facebook
        const series = [
          {
            name: 'TikTok Ads',
            data: tiktokGrowthByMonth,
            color: '#000000'
          },
          {
            name: 'Facebook Ads',
            data: facebookGrowthByMonth,
            color: '#1877f2'
          }
        ];

        customersOrdersChart.updateSeries(series);
      }

      // Update segment chart - Marketing ROI (LTV/CAC Ratio)
      function updateSegmentChart() {
        // Tính ROI cho mỗi kênh marketing (LTV/CAC)
        // ROI > 3 là tốt (LTV gấp 3 lần CAC)
        const channels = customerAcquisitionChannels.channels.filter(ch => ch.id !== 'direct');
        const ltv = customerAcquisitionChannels.ltv;
        const cac = customerAcquisitionChannels.cac;

        // Tính ROI ratio cho mỗi kênh (LTV/CAC)
        const roiData = channels.map(ch => {
          const ltvValue = ltv[ch.id];
          const cacValue = cac[ch.id] / 1000; // Convert từ nghìn VNĐ sang triệu VNĐ
          return cacValue > 0 ? (ltvValue / cacValue).toFixed(1) : 0;
        });

        const labels = channels.map(ch => ch.name);
        const colors = channels.map(ch => ch.color);

        segmentChart.updateOptions({
          chart: { type: 'bar', horizontal: true },
          series: [{
            name: 'ROI (LTV/CAC)',
            data: roiData.map(v => parseFloat(v))
          }],
          xaxis: {
            categories: labels,
            title: { text: 'ROI Ratio' }
          },
          yaxis: {
            title: { text: 'Kênh Marketing' }
          },
          colors: colors,
          plotOptions: {
            bar: {
              horizontal: true,
              distributed: true,
              dataLabels: {
                position: 'top'
              }
            }
          },
          dataLabels: {
            enabled: true,
            formatter: (val) => val.toFixed(1) + 'x',
            offsetX: 30,
            style: {
              fontSize: '12px',
              colors: ['#304758']
            }
          },
          legend: {
            show: false
          },
          tooltip: {
            y: {
              formatter: (val) => val.toFixed(1) + 'x (LTV/CAC)',
              title: {
                formatter: () => 'ROI: '
              }
            }
          }
        });
      }
    </script>
  </body>
</html>
