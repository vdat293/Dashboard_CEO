<!doctype html>
<html lang="vi">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Quản Lý Sản Phẩm | Dashboard CEO</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#007bff" media="(prefers-color-scheme: light)" />

    <!-- Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" />

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" crossorigin="anonymous" />

    <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css" />

    <!-- ApexCharts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css" integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../assets/css/variables.css" />
    <link rel="stylesheet" href="../assets/css/style.css" />
  </head>

  <body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">

      <!-- Header -->
      <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button">
              <i class="bi bi-list"></i>
            </a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="../dashboard.html" class="nav-link">Trang chủ</a>
          </li>
        </ul>

        <ul class="navbar-nav ms-auto">
          <!-- Location Badge (for non-CEO users) -->
          <li class="nav-item current-location-badge" style="display: none;">
            <span class="nav-link">
              <span class="badge badge-info" id="user-location-badge"></span>
            </span>
          </li>

          <!-- User Menu -->
          <li class="nav-item dropdown">
            <a class="nav-link" data-bs-toggle="dropdown" href="#">
              <i class="bi bi-person-circle"></i>
            </a>
            <div class="dropdown-menu dropdown-menu-end">
              <a href="#" class="dropdown-item">
                <i class="bi bi-person me-2"></i> Hồ sơ
              </a>
              <a href="#" class="dropdown-item">
                <i class="bi bi-gear me-2"></i> Cài đặt
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item" onclick="logout(); return false;">
                <i class="bi bi-box-arrow-right me-2"></i> Đăng xuất
              </a>
            </div>
          </li>
        </ul>
      </nav>

      <!-- Sidebar -->
      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <a href="../dashboard.html" class="brand-link">
          <i class="bi bi-graph-up-arrow brand-image" style="font-size: 2rem; margin-left: 0.5rem;"></i>
          <span class="brand-text font-weight-light">CEO Dashboard</span>
        </a>

        <div class="sidebar">
          <nav class="mt-2">
            <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
              <li class="nav-item">
                <a href="../dashboard.html" class="nav-link">
                  <i class="nav-icon bi bi-speedometer2"></i>
                  <p>Tổng quan</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="revenue.html" class="nav-link">
                  <i class="nav-icon bi bi-graph-up"></i>
                  <p>Doanh thu</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="customers.html" class="nav-link">
                  <i class="nav-icon bi bi-people"></i>
                  <p>Khách hàng</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="products.html" class="nav-link active">
                  <i class="nav-icon bi bi-box-seam"></i>
                  <p>Sản phẩm</p>
                </a>
              </li>
              <li class="nav-item ceo-only">
                <a href="kim-assistant.html" class="nav-link">
                  <i class="nav-icon bi bi-robot"></i>
                  <p>Kim - Trợ lý ảo</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-gear"></i>
                  <p>Cài đặt</p>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>

      <!-- Content Wrapper -->
      <div class="content-wrapper">
        <div class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1 class="m-0">Quản Lý Sản Phẩm</h1>
              </div>
              <div class="col-sm-6">
                <div class="float-sm-right">
                  <select id="location-selector" class="form-control location-filter" style="width: auto; display: inline-block; min-width: 200px;">
                    <option value="">Tất cả cơ sở (Tổng hợp)</option>
                    <option value="HN">Hà Nội</option>
                    <option value="HCM">TP. Hồ Chí Minh</option>
                    <option value="DN">Đà Nẵng</option>
                    <option value="HP">Hải Phòng</option>
                    <option value="CT">Cần Thơ</option>
                    <option value="NT">Nha Trang</option>
                    <option value="VT">Vũng Tàu</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main content -->
        <section class="content">
          <div class="container-fluid">

            <!-- Thống kê sản phẩm -->
            <div class="row">
              <div class="col-lg-3 col-6">
                <div class="info-box">
                  <span class="info-box-icon bg-gradient-primary elevation-1">
                    <i class="bi bi-box-seam"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Doanh số sản phẩm</span>
                    <span class="info-box-number" id="kpi-total-sales">
                      2.55 tỷ
                      <small class="trend-up">
                        <i class="bi bi-arrow-up"></i> <span id="kpi-sales-growth">12.3%</span>
                      </small>
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-lg-3 col-6">
                <div class="info-box">
                  <span class="info-box-icon bg-gradient-success elevation-1">
                    <i class="bi bi-check-circle"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Sản phẩm bán chạy</span>
                    <span class="info-box-number" id="kpi-best-seller">
                      iPhone 15 Pro Max
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-lg-3 col-6">
                <div class="info-box">
                  <span class="info-box-icon bg-gradient-info elevation-1">
                    <i class="bi bi-bar-chart"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Danh mục hàng đầu</span>
                    <span class="info-box-number" id="kpi-top-category">
                      Điện tử
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-lg-3 col-6">
                <div class="info-box">
                  <span class="info-box-icon bg-gradient-warning elevation-1">
                    <i class="bi bi-exclamation-triangle"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Cảnh báo tồn kho</span>
                    <span class="info-box-number" id="kpi-alerts">
                      <small class="text-warning">
                        <span id="alert-count">12</span> sản phẩm
                      </small>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Biểu đồ -->
            <div class="row">
              <div class="col-lg-8">
                <div class="card">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-graph-up mr-2"></i>
                      <span id="sales-trend-title">Xu hướng doanh số sản phẩm (Tổng hợp)</span>
                    </h3>
                  </div>
                  <div class="card-body">
                    <div id="sales-trend-chart" style="height: 350px;"></div>
                  </div>
                </div>
              </div>

              <div class="col-lg-4">
                <div class="card">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-pie-chart mr-2"></i>
                      Doanh số theo danh mục
                    </h3>
                  </div>
                  <div class="card-body">
                    <div id="category-sales-chart" style="height: 350px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Danh sách sản phẩm -->
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">Danh sách sản phẩm bán chạy</h3>
                    <div class="card-tools">
                      <div class="input-group input-group-sm" style="width: 250px;">
                        <input type="text" class="form-control" placeholder="Tìm kiếm sản phẩm..." />
                        <div class="input-group-append">
                          <button type="submit" class="btn btn-default">
                            <i class="bi bi-search"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="card-body table-responsive p-0">
                    <table class="table table-hover table-striped">
                      <thead>
                        <tr>
                          <th>STT</th>
                          <th>Tên sản phẩm</th>
                          <th>Danh mục</th>
                          <th>Giá bán</th>
                          <th class="text-center">Đã bán</th>
                          <th class="text-right">Doanh thu</th>
                        </tr>
                      </thead>
                      <tbody id="products-table-body">
                        <!-- Sẽ được populate bằng JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  <div class="card-footer clearfix">
                    <button type="button" class="btn btn-sm btn-primary float-end">
                      <i class="bi bi-plus-circle"></i> Thêm sản phẩm
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cảnh báo tồn kho -->
            <div class="row">
              <div class="col-md-6">
                <div class="card card-warning">
                  <div class="card-header">
                    <h3 class="card-title">
                      <i class="bi bi-exclamation-triangle mr-1"></i>
                      Cảnh báo quan trọng
                    </h3>
                    <div class="card-tools">
                      <button type="button" class="btn btn-sm btn-warning" onclick="viewAllAlerts('warning')">
                        <i class="bi bi-eye"></i> Xem đầy đủ
                      </button>
                    </div>
                  </div>
                  <div class="card-body p-0" id="warning-alerts-container" style="max-height: 400px; overflow-y: auto;">
                    <!-- Sẽ được populate bằng JavaScript -->
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card card-danger">
                  <div class="card-header">
                    <h3 class="card-title">
                      <i class="bi bi-x-circle mr-1"></i>
                      Cảnh báo khẩn cấp
                    </h3>
                    <div class="card-tools">
                      <button type="button" class="btn btn-sm btn-danger" onclick="viewAllAlerts('danger')">
                        <i class="bi bi-eye"></i> Xem đầy đủ
                      </button>
                    </div>
                  </div>
                  <div class="card-body p-0" id="danger-alerts-container" style="max-height: 400px; overflow-y: auto;">
                    <!-- Sẽ được populate bằng JavaScript -->
                  </div>
                </div>
              </div>
            </div>

          </div>
        </section>
      </div>

      <!-- Footer -->
      <footer class="main-footer">
        <strong>Copyright &copy; 2024 <a href="#">Công ty của bạn</a>.</strong>
        All rights reserved.
        <div class="float-end d-none d-sm-inline-block">
          <b>Version</b> 1.0.0
        </div>
      </footer>
    </div>

    <!-- Scripts -->
    <!-- jQuery (required for AdminLTE and chart interactions) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js" integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8=" crossorigin="anonymous"></script>

    <!-- Load Auth & Data -->
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/data.js"></script>

    <!-- Authentication Check -->
    <script>
      // Kiểm tra đăng nhập khi load trang
      requireAuth();

      // Hiển thị thông tin user
      displayUserInfo();

      // Cập nhật badge location cho user không phải CEO
      const user = getCurrentUser();
      if (user && user.role !== 'ceo') {
        const locationName = getLocationName(user.locations[0]);
        const badge = document.getElementById('user-location-badge');
        if (badge) {
          badge.textContent = locationName;
        }
      }
    </script>

    <script>
      // ============================================
      // STATE MANAGEMENT
      // ============================================
      let currentLocation = '';

      // Chart instances
      let salesTrendChart, categorySalesChart;

      // ============================================
      // INITIALIZE PAGE
      // ============================================
      $(document).ready(function() {
        initCharts();
        updateDashboard();

        // Event listeners
        $('#location-selector').on('change', function() {
          currentLocation = $(this).val();
          updateDashboard();
        });
      });

      // ============================================
      // CHART INITIALIZATION
      // ============================================
      function initCharts() {
        // Sales trend chart (area chart by categories)
        salesTrendChart = new ApexCharts(document.querySelector('#sales-trend-chart'), {
          series: [],
          chart: {
            type: 'area',
            height: 350,
            toolbar: { show: false },
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800,
              animateGradually: {
                enabled: true,
                delay: 150
              }
            }
          },
          colors: ['#007bff', '#28a745', '#17a2b8', '#ffc107', '#6f42c1', '#fd7e14'],
          dataLabels: { enabled: false },
          stroke: { curve: 'smooth', width: 3 },
          fill: {
            type: 'gradient',
            gradient: {
              shadeIntensity: 1,
              opacityFrom: 0.5,
              opacityTo: 0.1,
              stops: [0, 90, 100]
            }
          },
          xaxis: {
            categories: monthLabelsShort,
            labels: {
              style: { fontSize: '11px' }
            }
          },
          yaxis: {
            title: { text: 'Doanh số (triệu VNĐ)' },
            labels: {
              formatter: val => val.toFixed(0),
              style: { fontSize: '11px' }
            }
          },
          legend: {
            position: 'top',
            horizontalAlign: 'right',
            fontSize: '13px',
            fontWeight: 600
          },
          tooltip: {
            shared: true,
            intersect: false,
            y: {
              formatter: val => val.toFixed(0) + ' triệu VNĐ'
            }
          },
          responsive: [{
            breakpoint: 768,
            options: {
              chart: { height: 280 },
              dataLabels: { enabled: false },
              legend: {
                position: 'bottom',
                fontSize: '11px'
              }
            }
          }]
        });
        salesTrendChart.render();

        // Category sales chart (donut or bar)
        categorySalesChart = new ApexCharts(document.querySelector('#category-sales-chart'), {
          series: [],
          chart: {
            type: 'donut',
            height: 350,
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800,
              animateGradually: {
                enabled: true,
                delay: 150
              }
            }
          },
          labels: [],
          colors: ['#007bff', '#28a745', '#17a2b8', '#ffc107', '#6f42c1', '#fd7e14'],
          legend: {
            position: 'bottom',
            fontSize: '12px',
            markers: {
              width: 10,
              height: 10,
              radius: 2
            }
          },
          plotOptions: {
            pie: {
              donut: {
                size: '65%',
                labels: {
                  show: true,
                  name: {
                    fontSize: '14px',
                    fontWeight: 600
                  },
                  value: {
                    fontSize: '18px',
                    fontWeight: 700,
                    formatter: val => val + ' tr'
                  },
                  total: {
                    show: true,
                    label: 'Tổng',
                    fontSize: '14px',
                    fontWeight: 600,
                    formatter: (w) => {
                      const total = sumArray(w.globals.seriesTotals);
                      return total.toFixed(0) + ' tr';
                    }
                  }
                }
              }
            }
          },
          tooltip: {
            y: {
              formatter: val => val + ' triệu VNĐ'
            }
          },
          responsive: [{
            breakpoint: 768,
            options: {
              chart: { height: 300 },
              legend: {
                position: 'bottom',
                fontSize: '11px'
              }
            }
          }]
        });
        categorySalesChart.render();
      }

      // ============================================
      // UPDATE DASHBOARD
      // ============================================
      function updateDashboard() {
        updateKPIs();
        updateSalesTrendChart();
        updateCategorySalesChart();
        updateProductsTable();
        updateAlerts();
      }

      // ============================================
      // UPDATE KPIs
      // ============================================
      function updateKPIs() {
        let productData, title;

        if (currentLocation === '') {
          // Aggregate all locations
          productData = {
            categories: productsByLocation.HN.categories,
            sales: productsByLocation.HN.categories.map((cat, idx) => {
              return locations.reduce((sum, loc) => {
                return sum + (productsByLocation[loc.id].sales[idx] || 0);
              }, 0);
            }),
            topProducts: []
          };

          // Aggregate top products from all locations
          const allProducts = {};
          locations.forEach(loc => {
            productsByLocation[loc.id].topProducts.forEach(p => {
              if (!allProducts[p.name]) {
                allProducts[p.name] = { ...p };
              } else {
                allProducts[p.name].sold += p.sold;
                allProducts[p.name].revenue += p.revenue;
              }
            });
          });
          productData.topProducts = Object.values(allProducts).sort((a, b) => b.revenue - a.revenue);
          title = 'Tổng hợp';
        } else {
          productData = productsByLocation[currentLocation];
          const loc = locations.find(l => l.id === currentLocation);
          title = loc.name;
        }

        // Calculate KPIs
        const totalSales = sumArray(productData.sales);
        const bestSeller = productData.topProducts[0];
        const topCategory = productData.categories[productData.sales.indexOf(Math.max(...productData.sales))];

        // Get alerts count
        const alertsLoc = currentLocation === '' ? 'HN' : currentLocation;
        const alerts = notificationsByLocation[alertsLoc] || [];
        const alertCount = alerts.filter(a =>
          a.type === 'low_stock' || a.type === 'out_stock'
        ).length;

        // Update KPIs
        $('#kpi-total-sales').html(`
          ${(totalSales / 1000).toFixed(2)} tỷ
          <small class="trend-up">
            <i class="bi bi-arrow-up"></i> <span>12.3%</span>
          </small>
        `);

        $('#kpi-best-seller').text(bestSeller ? bestSeller.name : 'N/A');
        $('#kpi-top-category').text(topCategory);
        $('#alert-count').text(alertCount);

        // Update chart title
        $('#sales-trend-title').text(`Xu hướng doanh số sản phẩm (${title})`);
      }

      // ============================================
      // UPDATE SALES TREND CHART
      // ============================================
      function updateSalesTrendChart() {
        let series = [];

        if (currentLocation === '') {
          // Show all categories trend (aggregate from all locations)
          const categories = productsByLocation.HN.categories;
          series = categories.map(cat => {
            // Generate mock monthly data for each category
            const baseSales = locations.reduce((sum, loc) => {
              const idx = productsByLocation[loc.id].categories.indexOf(cat);
              return sum + (productsByLocation[loc.id].sales[idx] || 0);
            }, 0);

            // Create trend data (simulate monthly growth)
            const monthlyData = monthLabelsShort.map((_, monthIdx) => {
              const variance = (Math.random() * 0.2 - 0.1); // ±10% variance
              const trend = 1 + (monthIdx * 0.02); // 2% monthly growth
              return Math.round(baseSales / 12 * trend * (1 + variance));
            });

            return { name: cat, data: monthlyData };
          });
        } else {
          // Show categories trend for single location
          const categories = productsByLocation[currentLocation].categories;
          series = categories.map(cat => {
            const idx = productsByLocation[currentLocation].categories.indexOf(cat);
            const baseSales = productsByLocation[currentLocation].sales[idx];

            // Create trend data
            const monthlyData = monthLabelsShort.map((_, monthIdx) => {
              const variance = (Math.random() * 0.2 - 0.1);
              const trend = 1 + (monthIdx * 0.02);
              return Math.round(baseSales / 12 * trend * (1 + variance));
            });

            return { name: cat, data: monthlyData };
          });
        }

        salesTrendChart.updateSeries(series);
      }

      // ============================================
      // UPDATE CATEGORY SALES CHART
      // ============================================
      function updateCategorySalesChart() {
        let productData;

        if (currentLocation === '') {
          // Aggregate all locations
          productData = {
            categories: productsByLocation.HN.categories,
            sales: productsByLocation.HN.categories.map((cat, idx) => {
              return locations.reduce((sum, loc) => {
                return sum + (productsByLocation[loc.id].sales[idx] || 0);
              }, 0);
            })
          };
        } else {
          productData = productsByLocation[currentLocation];
        }

        categorySalesChart.updateOptions({
          series: productData.sales,
          labels: productData.categories
        });
      }

      // ============================================
      // UPDATE PRODUCTS TABLE
      // ============================================
      function updateProductsTable() {
        const tableBody = $('#products-table-body');
        tableBody.empty();

        let products;

        if (currentLocation === '') {
          // Aggregate top products from all locations
          const allProducts = {};
          locations.forEach(loc => {
            productsByLocation[loc.id].topProducts.forEach(p => {
              if (!allProducts[p.name]) {
                allProducts[p.name] = { ...p };
              } else {
                allProducts[p.name].sold += p.sold;
                allProducts[p.name].revenue += p.revenue;
              }
            });
          });
          products = Object.values(allProducts).sort((a, b) => b.revenue - a.revenue).slice(0, 10);
        } else {
          products = productsByLocation[currentLocation].topProducts;
        }

        // Render products
        products.forEach((product, idx) => {
          const icon = getProductIcon(product.category);
          const badgeColor = getCategoryBadgeColor(product.category);

          const row = `
            <tr>
              <td><strong>${idx + 1}</strong></td>
              <td>
                <i class="bi ${icon} text-${badgeColor} mr-2"></i>
                <strong>${product.name}</strong>
              </td>
              <td><span class="badge badge-${badgeColor}">${product.category}</span></td>
              <td>${formatCurrency(product.price)}</td>
              <td class="text-center"><strong>${product.sold}</strong></td>
              <td class="text-right text-success"><strong>${formatRevenueValue(product.revenue / 1000)}</strong></td>
            </tr>
          `;

          tableBody.append(row);
        });
      }

      // ============================================
      // UPDATE ALERTS
      // ============================================
      function updateAlerts() {
        const alertsLoc = currentLocation === '' ? 'HN' : currentLocation;
        const alerts = notificationsByLocation[alertsLoc] || [];

        // Phân loại alerts
        const warningAlerts = alerts.filter(a =>
          a.priority === 'high' || a.priority === 'medium' || a.type === 'low_stock' || a.type === 'return' || a.type === 'slow_moving'
        ).slice(0, 5);

        const dangerAlerts = alerts.filter(a =>
          a.priority === 'urgent' || a.type === 'out_stock' || a.type === 'defect'
        ).slice(0, 5);

        // Render warning alerts
        const warningContainer = document.getElementById('warning-alerts-container');
        if (warningContainer) {
          warningContainer.innerHTML = '<ul class="products-list product-list-in-card pl-2 pr-2">' +
            warningAlerts.map(alert => `
              <li class="item">
                <div class="product-img">
                  <i class="bi ${alert.icon} text-${alert.color}" style="font-size: 2rem;"></i>
                </div>
                <div class="product-info">
                  <a href="#" class="product-title">
                    ${alert.product}
                    <span class="badge badge-${alert.color} float-end">${alert.title}</span>
                  </a>
                  <span class="product-description">
                    ${alert.detail}
                    <br>
                    <small class="text-muted"><i class="bi bi-clock"></i> ${alert.time}</small>
                  </span>
                </div>
              </li>
            `).join('') +
            '</ul>';
        }

        // Render danger alerts
        const dangerContainer = document.getElementById('danger-alerts-container');
        if (dangerContainer) {
          dangerContainer.innerHTML = '<ul class="products-list product-list-in-card pl-2 pr-2">' +
            dangerAlerts.map(alert => `
              <li class="item">
                <div class="product-img">
                  <i class="bi ${alert.icon} text-${alert.color}" style="font-size: 2rem;"></i>
                </div>
                <div class="product-info">
                  <a href="#" class="product-title">
                    ${alert.product}
                    <span class="badge badge-${alert.color} float-end">${alert.title}</span>
                  </a>
                  <span class="product-description">
                    ${alert.detail}
                    <br>
                    <small class="text-muted"><i class="bi bi-clock"></i> ${alert.time}</small>
                  </span>
                </div>
              </li>
            `).join('') +
            '</ul>';
        }
      }

      // ============================================
      // HELPER FUNCTIONS
      // ============================================
      function getProductIcon(category) {
        const icons = {
          'Điện tử': 'bi-laptop',
          'Thời trang': 'bi-bag',
          'Gia dụng': 'bi-house',
          'Thực phẩm': 'bi-cup-straw',
          'Mỹ phẩm': 'bi-heart',
          'Sách vở': 'bi-book'
        };
        return icons[category] || 'bi-box';
      }

      function getCategoryBadgeColor(category) {
        const colors = {
          'Điện tử': 'primary',
          'Thời trang': 'success',
          'Gia dụng': 'info',
          'Thực phẩm': 'warning',
          'Mỹ phẩm': 'danger',
          'Sách vở': 'secondary'
        };
        return colors[category] || 'dark';
      }

      // Function to view all alerts
      function viewAllAlerts(type) {
        const alertsLoc = currentLocation === '' ? 'HN' : currentLocation;
        const alerts = notificationsByLocation[alertsLoc] || [];

        let filteredAlerts;
        let modalTitle;

        if (type === 'warning') {
          filteredAlerts = alerts.filter(a =>
            a.priority === 'high' || a.priority === 'medium' || a.type === 'low_stock' || a.type === 'return' || a.type === 'slow_moving'
          );
          modalTitle = 'Tất cả cảnh báo quan trọng';
        } else {
          filteredAlerts = alerts.filter(a =>
            a.priority === 'urgent' || a.type === 'out_stock' || a.type === 'defect'
          );
          modalTitle = 'Tất cả cảnh báo khẩn cấp';
        }

        alert(`${modalTitle}\n\n${filteredAlerts.map((a, i) =>
          `${i+1}. ${a.product}\n   ${a.title}: ${a.detail}\n   Thời gian: ${a.time}`
        ).join('\n\n')}`);
      }
    </script>
  </body>
</html>
