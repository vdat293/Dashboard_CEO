<!doctype html>
<html lang="vi">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Báo Cáo Tổng Hợp | Dashboard CEO</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#007bff" media="(prefers-color-scheme: light)" />

    <!-- Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" />

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" crossorigin="anonymous" />

    <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css" />

    <!-- ApexCharts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css" integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../assets/css/variables.css" />
    <link rel="stylesheet" href="../assets/css/style.css" />

    <style>
      /* Transition cho KPI updates */
      #report-title {
        transition: opacity 0.3s ease;
      }

      .info-box-number, .info-box-text {
        transition: all 0.3s ease;
      }

      .progress-bar {
        transition: width 0.5s ease;
      }

      /* Hiệu ứng khi click nút period */
      .period-btn {
        transition: all 0.2s ease;
      }

      .period-btn:active {
        transform: scale(0.95);
      }

      /* Transition cho content khi thay đổi period */
      .content {
        transition: opacity 0.2s ease;
      }

      /* Loading indicator */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .loading-overlay.active {
        display: flex;
      }

      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Highlight effect cho KPI cards khi update */
      .info-box.updating {
        animation: pulse 0.5s ease;
      }

      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
      }
    </style>
  </head>

  <body class="hold-transition sidebar-mini layout-fixed">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-spinner"></div>
    </div>

    <div class="wrapper">

      <!-- Header -->
      <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button">
              <i class="bi bi-list"></i>
            </a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="../index.html" class="nav-link">Trang chủ</a>
          </li>
        </ul>

        <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown">
            <a class="nav-link" data-toggle="dropdown" href="#">
              <i class="bi bi-bell-fill"></i>
              <span class="badge badge-warning navbar-badge">5</span>
            </a>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link" data-toggle="dropdown" href="#">
              <i class="bi bi-person-circle"></i>
              <span class="d-none d-md-inline ml-1">CEO Nguyễn Văn A</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- Sidebar -->
      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <a href="../index.html" class="brand-link">
          <i class="bi bi-graph-up-arrow brand-image" style="font-size: 2rem; margin-left: 0.5rem;"></i>
          <span class="brand-text font-weight-light">CEO Dashboard</span>
        </a>

        <div class="sidebar">
          <div class="user-panel mt-3 pb-3 mb-3 d-flex">
            <div class="image">
              <i class="bi bi-person-circle" style="font-size: 2.1rem; color: #fff;"></i>
            </div>
            <div class="info">
              <a href="#" class="d-block">Nguyễn Văn A</a>
              <small class="text-muted">Giám đốc điều hành</small>
            </div>
          </div>

          <nav class="mt-2">
            <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
              <li class="nav-item">
                <a href="../index.html" class="nav-link">
                  <i class="nav-icon bi bi-speedometer2"></i>
                  <p>Tổng quan</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="revenue.html" class="nav-link">
                  <i class="nav-icon bi bi-graph-up"></i>
                  <p>Doanh thu</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="customers.html" class="nav-link">
                  <i class="nav-icon bi bi-people"></i>
                  <p>Khách hàng</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="products.html" class="nav-link">
                  <i class="nav-icon bi bi-box-seam"></i>
                  <p>Sản phẩm</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="reports.html" class="nav-link active">
                  <i class="nav-icon bi bi-clipboard-data"></i>
                  <p>Báo cáo</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="kim-assistant.html" class="nav-link">
                  <i class="nav-icon bi bi-robot"></i>
                  <p>Kim - Trợ lý ảo</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-gear"></i>
                  <p>Cài đặt</p>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>

      <!-- Content Wrapper -->
      <div class="content-wrapper">
        <div class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1 class="m-0">Báo Cáo Tổng Hợp</h1>
              </div>
              <div class="col-sm-6">
                <div class="float-sm-right">
                  <select id="location-selector" class="form-control" style="width: auto; display: inline-block; min-width: 200px;">
                    <option value="">Tất cả cơ sở (Tổng hợp)</option>
                    <option value="HN">Hà Nội</option>
                    <option value="HCM">TP. Hồ Chí Minh</option>
                    <option value="DN">Đà Nẵng</option>
                    <option value="HP">Hải Phòng</option>
                    <option value="CT">Cần Thơ</option>
                    <option value="NT">Nha Trang</option>
                    <option value="VT">Vũng Tàu</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main content -->
        <section class="content">
          <div class="container-fluid">

            <!-- Chọn khoảng thời gian -->
            <div class="row">
              <div class="col-12">
                <div class="card border-0">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-calendar-range mr-2"></i>
                      Khoảng thời gian báo cáo
                    </h3>
                  </div>
                  <div class="card-body">
                    <div class="btn-group d-flex" role="group">
                      <button type="button" class="btn btn-outline-primary flex-fill period-btn" id="btn-weekly" data-period="weekly">
                        <i class="bi bi-calendar-week"></i> Theo tuần
                      </button>
                      <button type="button" class="btn btn-primary flex-fill period-btn active" id="btn-monthly" data-period="monthly">
                        <i class="bi bi-calendar-month"></i> Theo tháng
                      </button>
                      <button type="button" class="btn btn-outline-primary flex-fill period-btn" id="btn-quarterly" data-period="quarterly">
                        <i class="bi bi-calendar3"></i> Theo quý
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- KPI tổng quan -->
            <div class="row">
              <div class="col-md-12">
                <div class="card border-0">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-bar-chart-fill mr-2"></i>
                      <span id="report-title">Tổng quan tháng 11/2025</span>
                    </h3>
                    <div class="card-tools">
                      <button type="button" class="btn btn-sm btn-success">
                        <i class="bi bi-file-earmark-pdf"></i> Xuất PDF
                      </button>
                      <button type="button" class="btn btn-sm btn-primary">
                        <i class="bi bi-file-earmark-excel"></i> Xuất Excel
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-3">
                        <div class="info-box bg-gradient-primary elevation-1">
                          <span class="info-box-icon"><i class="bi bi-currency-dollar"></i></span>
                          <div class="info-box-content">
                            <span class="info-box-text">Tổng doanh thu</span>
                            <span class="info-box-number" id="kpi-revenue">3.68 tỷ</span>
                            <div class="progress">
                              <div class="progress-bar" id="kpi-revenue-progress" style="width: 92%"></div>
                            </div>
                            <span class="progress-description" id="kpi-revenue-desc">
                              92% mục tiêu (4 tỷ)
                            </span>
                          </div>
                        </div>
                      </div>

                      <div class="col-md-3">
                        <div class="info-box bg-gradient-success elevation-1">
                          <span class="info-box-icon"><i class="bi bi-graph-up"></i></span>
                          <div class="info-box-content">
                            <span class="info-box-text">Lợi nhuận</span>
                            <span class="info-box-number" id="kpi-profit">1.29 tỷ</span>
                            <div class="progress">
                              <div class="progress-bar" id="kpi-profit-progress" style="width: 90%"></div>
                            </div>
                            <span class="progress-description" id="kpi-profit-desc">
                              35.0% biên lợi nhuận
                            </span>
                          </div>
                        </div>
                      </div>

                      <div class="col-md-3">
                        <div class="info-box bg-gradient-warning elevation-1">
                          <span class="info-box-icon"><i class="bi bi-cart"></i></span>
                          <div class="info-box-content">
                            <span class="info-box-text">Đơn hàng</span>
                            <span class="info-box-number" id="kpi-orders">4,892</span>
                            <div class="progress">
                              <div class="progress-bar" id="kpi-orders-progress" style="width: 98%"></div>
                            </div>
                            <span class="progress-description" id="kpi-orders-desc">
                              Giá trị TB: 752,000đ
                            </span>
                          </div>
                        </div>
                      </div>

                      <div class="col-md-3">
                        <div class="info-box bg-gradient-info elevation-1">
                          <span class="info-box-icon"><i class="bi bi-people"></i></span>
                          <div class="info-box-content">
                            <span class="info-box-text">Khách hàng mới</span>
                            <span class="info-box-number" id="kpi-customers">1,456</span>
                            <div class="progress">
                              <div class="progress-bar" id="kpi-customers-progress" style="width: 97%"></div>
                            </div>
                            <span class="progress-description" id="kpi-customers-desc">
                              +6.7% so với tháng trước
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Báo cáo theo từng mảng -->
            <div class="row">
              <!-- Báo cáo doanh thu -->
              <div class="col-md-6">
                <div class="card border-0">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-currency-dollar mr-2"></i>
                      Báo cáo Doanh thu
                    </h3>
                  </div>
                  <div class="card-body p-0">
                    <div class="table-responsive">
                      <table class="table table-hover m-0">
                        <thead class="bg-light">
                          <tr>
                            <th>Chỉ tiêu</th>
                            <th>Giá trị</th>
                            <th>% Hoàn thành</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>Doanh thu tháng</td>
                            <td><strong>3.68 tỷ</strong></td>
                            <td><span class="badge badge-success">92%</span></td>
                          </tr>
                          <tr>
                            <td>Doanh thu năm</td>
                            <td><strong>35.94 tỷ</strong></td>
                            <td><span class="badge badge-success">90%</span></td>
                          </tr>
                          <tr>
                            <td>Tăng trưởng MoM</td>
                            <td><strong>+7.6%</strong></td>
                            <td><span class="badge badge-success">Tốt</span></td>
                          </tr>
                          <tr>
                            <td>Tăng trưởng YoY</td>
                            <td><strong>+15.0%</strong></td>
                            <td><span class="badge badge-success">Tốt</span></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Báo cáo khách hàng -->
              <div class="col-md-6">
                <div class="card border-0">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-people mr-2"></i>
                      Báo cáo Khách hàng
                    </h3>
                  </div>
                  <div class="card-body p-0">
                    <div class="table-responsive">
                      <table class="table table-hover m-0">
                        <thead class="bg-light">
                          <tr>
                            <th>Chỉ tiêu</th>
                            <th>Giá trị</th>
                            <th>% Thay đổi</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>Tổng khách hàng</td>
                            <td><strong>15,678</strong></td>
                            <td><span class="badge badge-success">+10.2%</span></td>
                          </tr>
                          <tr>
                            <td>Khách hàng mới</td>
                            <td><strong>1,456</strong></td>
                            <td><span class="badge badge-success">+6.7%</span></td>
                          </tr>
                          <tr>
                            <td>Khách hàng VIP</td>
                            <td><strong>342</strong></td>
                            <td><span class="badge badge-success">+12%</span></td>
                          </tr>
                          <tr>
                            <td>Tỷ lệ giữ chân</td>
                            <td><strong>92.5%</strong></td>
                            <td><span class="badge badge-success">+1.5%</span></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Biểu đồ tổng hợp -->
            <div class="row">
              <div class="col-md-12">
                <div class="card border-0">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-graph-up mr-2"></i>
                      Xu hướng kinh doanh 12 tháng
                    </h3>
                  </div>
                  <div class="card-body">
                    <div id="business-trend-chart" style="height: 400px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Báo cáo sản phẩm và hoạt động -->
            <div class="row">
              <div class="col-md-6">
                <div class="card border-0">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-box-seam mr-2"></i>
                      Top 5 sản phẩm đóng góp doanh thu
                    </h3>
                  </div>
                  <div class="card-body">
                    <div id="top-products-chart" style="height: 300px;"></div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card border-0">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-shop mr-2"></i>
                      Hiệu suất theo kênh bán hàng
                    </h3>
                  </div>
                  <div class="card-body">
                    <div id="channel-performance-chart" style="height: 300px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Nhận xét và đề xuất -->
            <div class="row">
              <!-- Điểm mạnh -->
              <div class="col-md-4">
                <div class="card card-success">
                  <div class="card-header">
                    <h3 class="card-title">
                      <i class="bi bi-check-circle mr-2"></i>
                      Điểm mạnh
                    </h3>
                  </div>
                  <div class="card-body">
                    <ul class="list-unstyled">
                      <li class="mb-2">
                        <i class="bi bi-arrow-up-circle text-success mr-1"></i>
                        Doanh thu tăng trưởng ổn định 12% so với tháng trước
                      </li>
                      <li class="mb-2">
                        <i class="bi bi-arrow-up-circle text-success mr-1"></i>
                        Tỷ lệ khách hàng quay lại cao (92.5%)
                      </li>
                      <li class="mb-2">
                        <i class="bi bi-arrow-up-circle text-success mr-1"></i>
                        Biên lợi nhuận cải thiện lên 34%
                      </li>
                      <li class="mb-2">
                        <i class="bi bi-arrow-up-circle text-success mr-1"></i>
                        Sản phẩm mới được thị trường đón nhận tốt
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Điểm cần cải thiện -->
              <div class="col-md-4">
                <div class="card card-warning">
                  <div class="card-header">
                    <h3 class="card-title">
                      <i class="bi bi-exclamation-triangle mr-2"></i>
                      Điểm cần cải thiện
                    </h3>
                  </div>
                  <div class="card-body">
                    <ul class="list-unstyled">
                      <li class="mb-2">
                        <i class="bi bi-exclamation-circle text-warning mr-1"></i>
                        Tình trạng hết hàng ở một số sản phẩm chủ lực
                      </li>
                      <li class="mb-2">
                        <i class="bi bi-exclamation-circle text-warning mr-1"></i>
                        Chi phí marketing tăng cao hơn dự kiến
                      </li>
                      <li class="mb-2">
                        <i class="bi bi-exclamation-circle text-warning mr-1"></i>
                        Thời gian giao hàng trung bình tăng nhẹ
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Đề xuất -->
              <div class="col-md-4">
                <div class="card card-primary">
                  <div class="card-header">
                    <h3 class="card-title">
                      <i class="bi bi-lightbulb mr-2"></i>
                      Đề xuất hành động
                    </h3>
                  </div>
                  <div class="card-body">
                    <ul class="list-unstyled">
                      <li class="mb-2">
                        <i class="bi bi-arrow-right-circle text-primary mr-1"></i>
                        Tăng cường quản lý tồn kho, đặc biệt sản phẩm bán chạy
                      </li>
                      <li class="mb-2">
                        <i class="bi bi-arrow-right-circle text-primary mr-1"></i>
                        Tối ưu hóa chi phí marketing, tập trung vào kênh hiệu quả
                      </li>
                      <li class="mb-2">
                        <i class="bi bi-arrow-right-circle text-primary mr-1"></i>
                        Cải thiện quy trình logistics để giảm thời gian giao hàng
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </section>
      </div>

      <!-- Footer -->
      <footer class="main-footer">
        <strong>Copyright &copy; 2024 <a href="#">Công ty của bạn</a>.</strong>
        All rights reserved.
        <div class="float-right d-none d-sm-inline-block">
          <b>Version</b> 1.0.0
        </div>
      </footer>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js" integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8=" crossorigin="anonymous"></script>

    <!-- Load Data -->
    <script src="../assets/js/data.js"></script>

    <script>
      // ============================================
      // BIẾN GLOBAL VÀ KHỞI TẠO
      // ============================================

      let currentPeriod = 'monthly'; // Mặc định là theo tháng
      let businessTrendChart;

      // ============================================
      // HÀM FORMAT DỮ LIỆU
      // ============================================

      function formatCurrency(value) {
        if (value >= 1000) {
          return (value / 1000).toFixed(2) + ' tỷ';
        }
        return value + ' triệu';
      }

      function formatNumber(value) {
        return value.toLocaleString('vi-VN');
      }

      // ============================================
      // HÀM CẬP NHẬT KPI
      // ============================================

      function updateKPIs(period) {
        console.log('Updating KPIs for period:', period); // Debug

        const data = businessDataByMonth[2025];
        let revenue, profit, orders, customers;
        let periodLabel;
        let targetRevenue; // Mục tiêu doanh thu thay đổi theo kỳ

        if (period === 'weekly') {
          // Lấy tuần 1 của tháng 11
          const weeklyRevenue = calculateWeeklyData(data.revenue);
          const weeklyProfit = calculateWeeklyData(data.profit);
          const weeklyOrders = calculateWeeklyData(data.orders);
          const weeklyCustomers = calculateWeeklyData(data.newCustomers);

          // Tuần 1 của tháng 11 = tuần thứ 41 (10 tháng x 4 tuần = 40, index 40)
          revenue = weeklyRevenue[40];
          profit = weeklyProfit[40];
          orders = weeklyOrders[40];
          customers = weeklyCustomers[40];
          periodLabel = 'Tuần 1 - Tháng 11/2025';
          targetRevenue = 1000; // Mục tiêu 1 tỷ/tuần
        } else if (period === 'quarterly') {
          // Quý 3 (tháng 7-8-9)
          const quarterlyRevenue = calculateQuarterlyData(data.revenue);
          const quarterlyProfit = calculateQuarterlyData(data.profit);
          const quarterlyOrders = calculateQuarterlyData(data.orders);
          const quarterlyCustomers = calculateQuarterlyData(data.newCustomers);

          revenue = quarterlyRevenue[2]; // Quý 3 (index 2)
          profit = quarterlyProfit[2];
          orders = quarterlyOrders[2];
          customers = quarterlyCustomers[2];
          periodLabel = 'Quý 3/2025';
          targetRevenue = 12000; // Mục tiêu 12 tỷ/quý
        } else { // monthly
          // Tháng 11
          revenue = data.revenue[10]; // Tháng 11 (index 10)
          profit = data.profit[10];
          orders = data.orders[10];
          customers = data.newCustomers[10];
          periodLabel = 'Tháng 11/2025';
          targetRevenue = 4000; // Mục tiêu 4 tỷ/tháng
        }

        console.log('Period:', period, '| Revenue:', revenue, 'Profit:', profit, 'Orders:', orders, 'Customers:', customers); // Debug

        // Thêm animation cho tất cả KPI cards
        document.querySelectorAll('.info-box').forEach(box => {
          box.classList.add('updating');
        });

        // Remove animation sau khi hoàn thành
        setTimeout(() => {
          document.querySelectorAll('.info-box').forEach(box => {
            box.classList.remove('updating');
          });
        }, 500);

        // Cập nhật tiêu đề với hiệu ứng fade
        const titleElement = document.getElementById('report-title');
        titleElement.style.opacity = '0.5';
        setTimeout(() => {
          titleElement.textContent = `Tổng quan ${periodLabel}`;
          titleElement.style.opacity = '1';
        }, 150);

        // Cập nhật KPI revenue với animation
        document.getElementById('kpi-revenue').textContent = formatCurrency(revenue);
        const revenueProgress = Math.min(100, (revenue / targetRevenue) * 100);
        document.getElementById('kpi-revenue-progress').style.width = revenueProgress + '%';
        document.getElementById('kpi-revenue-desc').textContent = `${revenueProgress.toFixed(0)}% mục tiêu (${formatCurrency(targetRevenue)})`;

        // Cập nhật KPI profit
        document.getElementById('kpi-profit').textContent = formatCurrency(profit);
        const profitMargin = ((profit / revenue) * 100).toFixed(1);
        document.getElementById('kpi-profit-progress').style.width = Math.min(100, profitMargin * 3);
        document.getElementById('kpi-profit-desc').textContent = `${profitMargin}% biên lợi nhuận`;

        // Cập nhật KPI orders
        document.getElementById('kpi-orders').textContent = formatNumber(orders);
        const avgOrderValue = (revenue * 1000000 / orders).toFixed(0);
        document.getElementById('kpi-orders-progress').style.width = '98%';
        document.getElementById('kpi-orders-desc').textContent = `Giá trị TB: ${formatNumber(avgOrderValue)}đ`;

        // Cập nhật KPI customers
        document.getElementById('kpi-customers').textContent = formatNumber(customers);
        document.getElementById('kpi-customers-progress').style.width = '97%';
        document.getElementById('kpi-customers-desc').textContent = `Khách hàng mới trong kỳ`;
      }

      // ============================================
      // HÀM CẬP NHẬT BIỂU ĐỒ XU HƯỚNG
      // ============================================

      function updateBusinessTrendChart(period) {
        console.log('Updating chart for period:', period); // Debug

        const data = businessDataByMonth[2025];
        const labels = getLabelsForPeriod(period);

        const revenueData = transformDataByPeriod(data.revenue, period);
        const profitData = transformDataByPeriod(data.profit, period);
        const customersData = transformDataByPeriod(data.customers, period);

        console.log('Chart data - Revenue:', revenueData.slice(0, 5), '...'); // Debug first 5 values
        console.log('Chart data - Profit:', profitData.slice(0, 5), '...'); // Debug first 5 values
        console.log('Chart data - Customers:', customersData.slice(0, 5), '...'); // Debug first 5 values

        const periodText = period === 'weekly' ? '48 tuần (2025)' : period === 'quarterly' ? '4 quý (2025)' : '12 tháng (2025)';

        businessTrendChart.updateOptions({
          series: [{
            name: 'Doanh thu (triệu)',
            type: 'column',
            data: revenueData
          }, {
            name: 'Lợi nhuận (triệu)',
            type: 'line',
            data: profitData
          }, {
            name: 'Khách hàng hoạt động',
            type: 'line',
            data: customersData
          }],
          xaxis: {
            categories: labels
          }
        });

        // Cập nhật tiêu đề chart
        document.querySelector('#business-trend-chart').closest('.card').querySelector('.card-title').innerHTML =
          `<i class="bi bi-graph-up mr-2"></i>Xu hướng kinh doanh ${periodText}`;
      }

      // ============================================
      // XỬ LÝ SỰ KIỆN CLICK NÚT PERIOD
      // ============================================

      document.addEventListener('DOMContentLoaded', function() {
        // Khởi tạo biểu đồ xu hướng kinh doanh
        businessTrendChart = new ApexCharts(document.querySelector('#business-trend-chart'), {
          series: [{
            name: 'Doanh thu (triệu)',
            type: 'column',
            data: businessDataByMonth[2025].revenue
          }, {
            name: 'Lợi nhuận (triệu)',
            type: 'line',
            data: businessDataByMonth[2025].profit
          }, {
            name: 'Khách hàng hoạt động',
            type: 'line',
            data: businessDataByMonth[2025].customers
          }],
          chart: { height: 400, type: 'line', toolbar: { show: true } },
          stroke: { width: [0, 2, 2], curve: 'smooth' },
          plotOptions: { bar: { columnWidth: '50%' } },
          colors: ['#007bff', '#28a745', '#ffc107'],
          fill: { opacity: [0.85, 1, 1] },
          labels: monthLabelsShort,
          markers: { size: 0 },
          yaxis: [
            {
              title: { text: 'Doanh thu & Lợi nhuận (triệu VNĐ)' },
              labels: { formatter: val => val.toFixed(0) }
            },
            {
              opposite: true,
              title: { text: 'Khách hàng' },
              labels: { formatter: val => val.toFixed(0) }
            }
          ],
          tooltip: {
            y: {
              formatter: (val, opts) => {
                if (opts.seriesIndex === 2) return val.toFixed(0) + ' khách';
                return val.toFixed(0) + ' triệu VNĐ';
              }
            }
          }
        });
        businessTrendChart.render();

        // Biểu đồ top sản phẩm
        const topProductsChart = new ApexCharts(document.querySelector('#top-products-chart'), {
          series: [{
            name: 'Doanh thu',
            data: topProducts.map(p => parseInt(p.revenue.replace(/[^\d]/g, '')))
          }],
          chart: { type: 'bar', height: 300 },
          plotOptions: { bar: { borderRadius: 4, horizontal: true } },
          colors: ['#007bff'],
          dataLabels: { enabled: false },
          xaxis: {
            categories: topProducts.map(p => p.name),
            labels: { formatter: val => val + ' triệu' }
          },
          tooltip: {
            y: { formatter: val => val + ' triệu VNĐ' }
          }
        });
        topProductsChart.render();

        // Biểu đồ kênh bán hàng
        const channelChart = new ApexCharts(document.querySelector('#channel-performance-chart'), {
          series: salesChannels.percentages,
          chart: { type: 'donut', height: 300 },
          labels: salesChannels.labels,
          colors: salesChannels.colors,
          legend: { position: 'bottom' },
          plotOptions: {
            pie: {
              donut: {
                labels: {
                  show: true,
                  total: {
                    show: true,
                    label: 'Tổng',
                    formatter: () => '100%'
                  }
                }
              }
            }
          },
          tooltip: {
            y: { formatter: val => val + '%' }
          }
        });
        channelChart.render();

        // Xử lý click nút period
        document.querySelectorAll('.period-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            const newPeriod = this.getAttribute('data-period');

            console.log('========================================'); // Debug
            console.log('Period button clicked:', newPeriod); // Debug
            console.log('Previous period:', currentPeriod); // Debug

            // Kiểm tra nếu đã chọn period này rồi thì không làm gì
            if (currentPeriod === newPeriod) {
              console.log('Same period selected, skipping update'); // Debug
              return;
            }

            // Xóa class active từ tất cả nút
            document.querySelectorAll('.period-btn').forEach(b => {
              b.classList.remove('btn-primary', 'active');
              b.classList.add('btn-outline-primary');
            });

            // Thêm class active cho nút được click
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary', 'active');

            // Cập nhật period hiện tại
            currentPeriod = newPeriod;

            // Hiển thị loading overlay
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.add('active');

            // Thêm loading indicator cho content
            const contentElement = document.querySelector('.content');
            contentElement.style.opacity = '0.7';
            contentElement.style.pointerEvents = 'none'; // Disable clicks during update

            // Cập nhật KPI và biểu đồ với delay nhỏ để thấy hiệu ứng
            setTimeout(() => {
              try {
                updateKPIs(currentPeriod);
                updateBusinessTrendChart(currentPeriod);
                console.log('Update completed successfully'); // Debug
              } catch (error) {
                console.error('Error updating data:', error); // Debug
              } finally {
                // Ẩn loading overlay
                setTimeout(() => {
                  loadingOverlay.classList.remove('active');
                  contentElement.style.opacity = '1';
                  contentElement.style.pointerEvents = 'auto'; // Re-enable clicks
                  console.log('========================================'); // Debug
                }, 200); // Delay nhỏ để thấy hiệu ứng
              }
            }, 100);
          });
        });

        // Xử lý location selector
        document.getElementById('location-selector').addEventListener('change', function() {
          const location = this.value;
          // TODO: Implement location filtering logic
          console.log('Location changed to:', location || 'Tất cả');
        });

        // Khởi tạo KPI ban đầu
        updateKPIs(currentPeriod);
      });
    </script>
  </body>
</html>
