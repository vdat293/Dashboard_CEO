<!doctype html>
<html lang="vi">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Doanh Thu Chi Tiết | Dashboard CEO</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#007bff" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)" />

    <!-- Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" />

    <!-- OverlayScrollbars -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css" crossorigin="anonymous" />

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" crossorigin="anonymous" />

    <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css" />

    <!-- ApexCharts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css" integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../assets/css/variables.css" />
    <link rel="stylesheet" href="../assets/css/style.css" />
  </head>

  <body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">

      <!-- Header -->
      <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button">
              <i class="bi bi-list"></i>
            </a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="../dashboard.html" class="nav-link">Trang chủ</a>
          </li>
        </ul>

        <ul class="navbar-nav ms-auto">
          <!-- Location Badge (for non-CEO users) -->
          <li class="nav-item current-location-badge" style="display: none;">
            <span class="nav-link">
              <span class="badge badge-info" id="user-location-badge"></span>
            </span>
          </li>

          <!-- User Menu -->
          <li class="nav-item dropdown">
            <a class="nav-link" data-bs-toggle="dropdown" href="#">
              <i class="bi bi-person-circle"></i>
              <span class="d-none d-md-inline ms-1 user-name"></span>
            </a>
            <div class="dropdown-menu dropdown-menu-end">
              <div class="dropdown-item-text">
                <div class="d-flex align-items-center">
                  <div>
                    <strong class="user-name"></strong><br>
                    <small class="text-muted user-title"></small>
                  </div>
                </div>
              </div>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item">
                <i class="bi bi-person me-2"></i> Hồ sơ
              </a>
              <a href="#" class="dropdown-item">
                <i class="bi bi-gear me-2"></i> Cài đặt
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item" onclick="logout(); return false;">
                <i class="bi bi-box-arrow-right me-2"></i> Đăng xuất
              </a>
            </div>
          </li>
        </ul>
      </nav>

      <!-- Sidebar -->
      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <a href="../dashboard.html" class="brand-link">
          <i class="bi bi-graph-up-arrow brand-image" style="font-size: 2rem; margin-left: 0.5rem;"></i>
          <span class="brand-text font-weight-light">CEO Dashboard</span>
        </a>

        <div class="sidebar">
          <div class="user-panel mt-3 pb-3 mb-3 d-flex">
            <div class="image">
              <i class="bi bi-person-circle" style="font-size: 2.1rem; color: #fff;"></i>
            </div>
            <div class="info">
              <a href="#" class="d-block user-name"></a>
              <small class="text-muted user-title"></small>
            </div>
          </div>

          <nav class="mt-2">
            <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
              <li class="nav-item">
                <a href="../dashboard.html" class="nav-link">
                  <i class="nav-icon bi bi-speedometer2"></i>
                  <p>Tổng quan</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="revenue.html" class="nav-link active">
                  <i class="nav-icon bi bi-graph-up"></i>
                  <p>Doanh thu</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="customers.html" class="nav-link">
                  <i class="nav-icon bi bi-people"></i>
                  <p>Khách hàng</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="products.html" class="nav-link">
                  <i class="nav-icon bi bi-box-seam"></i>
                  <p>Sản phẩm</p>
                </a>
              </li>
              <li class="nav-item ceo-only">
                <a href="kim-assistant.html" class="nav-link">
                  <i class="nav-icon bi bi-robot"></i>
                  <p>Kim - Trợ lý ảo</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-gear"></i>
                  <p>Cài đặt</p>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>

      <!-- Content Wrapper -->
      <div class="content-wrapper">
        <div class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1 class="m-0">Doanh Thu Chi Tiết</h1>
              </div>
              <div class="col-sm-6">
                <div class="float-sm-end">
                  <select id="location-selector" class="form-control location-filter" style="width: auto; display: inline-block; min-width: 200px;">
                    <option value="">Tất cả cơ sở (Tổng hợp)</option>
                    <option value="HN">Hà Nội</option>
                    <option value="HCM">TP. Hồ Chí Minh</option>
                    <option value="DN">Đà Nẵng</option>
                    <option value="HP">Hải Phòng</option>
                    <option value="CT">Cần Thơ</option>
                    <option value="NT">Nha Trang</option>
                    <option value="VT">Vũng Tàu</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main content -->
        <section class="content">
          <div class="container-fluid">

            <!-- Tổng quan doanh thu -->
            <div class="row">
              <div class="col-lg-3 col-6">
                <div class="info-box">
                  <span class="info-box-icon bg-gradient-primary elevation-1">
                    <i class="bi bi-currency-dollar"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Doanh thu tháng này</span>
                    <span class="info-box-number" id="kpi-revenue">
                      14.22 tỷ
                      <small class="trend-up">
                        <i class="bi bi-arrow-up"></i> <span id="kpi-revenue-growth">14.1%</span>
                      </small>
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-lg-3 col-6">
                <div class="info-box">
                  <span class="info-box-icon bg-gradient-success elevation-1">
                    <i class="bi bi-graph-up-arrow"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Doanh thu năm nay</span>
                    <span class="info-box-number" id="kpi-yearly">
                      167.48 tỷ
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-lg-3 col-6">
                <div class="info-box">
                  <span class="info-box-icon bg-gradient-info elevation-1">
                    <i class="bi bi-bar-chart"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Trung bình/tháng</span>
                    <span class="info-box-number" id="kpi-average">
                      13.96 tỷ
                    </span>
                  </div>
                </div>
              </div>

              <div class="col-lg-3 col-6">
                <div class="info-box">
                  <span class="info-box-icon bg-gradient-warning elevation-1">
                    <i class="bi bi-arrow-up-circle"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Tăng trưởng YoY</span>
                    <span class="info-box-number" id="kpi-yoy">
                      <small class="trend-up">
                        <i class="bi bi-arrow-up"></i> +13.6%
                      </small>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Biểu đồ doanh thu -->
            <div class="row">
              <div class="col-lg-8">
                <div class="card">
                  <div class="card-header border-0">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                      <h3 class="card-title mb-2 mb-md-0">
                        <i class="bi bi-graph-up mr-2"></i>
                        <span id="chart-title">Doanh thu theo tháng (Tổng hợp)</span>
                      </h3>
                      <div class="btn-group-sm">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-compare-years">
                          <i class="bi bi-calendar3-range"></i>
                          <span class="d-none d-sm-inline"> So sánh năm</span>
                        </button>
                        <button type="button" class="btn btn-sm btn-primary ml-1">
                          <i class="bi bi-download"></i>
                          <span class="d-none d-sm-inline"> Xuất dữ liệu</span>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div id="revenue-trend-chart" style="height: 400px;"></div>
                  </div>
                </div>
              </div>

              <div class="col-lg-4">
                <div class="card">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-pie-chart mr-2"></i>
                      Phân bố doanh thu
                    </h3>
                  </div>
                  <div class="card-body">
                    <div id="revenue-distribution-chart" style="height: 400px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Phân tích chi tiết -->
            <div class="row">
              <div class="col-lg-6">
                <div class="card">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-bar-chart-line mr-2"></i>
                      So sánh Doanh thu - Chi phí - Lợi nhuận
                    </h3>
                  </div>
                  <div class="card-body">
                    <div id="revenue-expense-profit-chart" style="height: 350px;"></div>
                  </div>
                </div>
              </div>

              <div class="col-lg-6">
                <div class="card">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-percent mr-2"></i>
                      Biên lợi nhuận theo tháng
                    </h3>
                  </div>
                  <div class="card-body">
                    <div id="profit-margin-chart" style="height: 350px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bảng chi tiết -->
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header border-0">
                    <h3 class="card-title">
                      <i class="bi bi-table mr-2"></i>
                      Chi tiết doanh thu theo tháng
                    </h3>
                  </div>
                  <div class="card-body table-responsive p-0">
                    <table class="table table-hover table-striped">
                      <thead class="bg-light">
                        <tr>
                          <th>Tháng</th>
                          <th class="text-right">Doanh thu</th>
                          <th class="text-right">Chi phí</th>
                          <th class="text-right">Lợi nhuận</th>
                          <th class="text-center">Biên LN</th>
                          <th class="text-center">So với năm trước</th>
                          <th class="text-center">Trạng thái</th>
                        </tr>
                      </thead>
                      <tbody id="revenue-table-body">
                        <!-- Will be populated by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </section>
      </div>

      <!-- Footer -->
      <footer class="main-footer">
        <strong>Copyright &copy; 2024 <a href="#">Công ty của bạn</a>.</strong>
        All rights reserved.
        <div class="float-end d-none d-sm-inline-block">
          <b>Version</b> 1.0.0
        </div>
      </footer>
    </div>

    <!-- Scripts -->
    <!-- jQuery (required for AdminLTE and chart interactions) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js" integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8=" crossorigin="anonymous"></script>

    <!-- Load Auth & Data -->
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/data.js"></script>

    <!-- Authentication Check -->
    <script>
      // Kiểm tra đăng nhập khi load trang
      requireAuth();

      // Hiển thị thông tin user
      displayUserInfo();

      // Cập nhật badge location cho user không phải CEO
      const user = getCurrentUser();
      if (user && user.role !== 'ceo') {
        const locationName = getLocationName(user.locations[0]);
        const badge = document.getElementById('user-location-badge');
        if (badge) {
          badge.textContent = locationName;
        }
      }
    </script>

    <script>
      // State management
      let currentLocation = '';
      let showYearComparison = false;

      // Chart instances
      let revenueTrendChart, distributionChart, revenueExpenseProfitChart, profitMarginChart;

      // Initialize page
      $(document).ready(function() {
        initCharts();
        updateDashboard();

        // Event listeners
        $('#location-selector').on('change', function() {
          currentLocation = $(this).val();
          updateDashboard();
        });

        $('#btn-compare-years').on('click', function() {
          showYearComparison = !showYearComparison;
          updateRevenueTrendChart();
          $(this).toggleClass('btn-primary btn-outline-primary');

          // Update button text based on state
          const icon = $(this).find('i');
          const text = $(this).find('span');
          if (showYearComparison) {
            icon.removeClass('bi-calendar3-range').addClass('bi-calendar-check');
            text.text(' Đang so sánh 3 năm');
          } else {
            icon.removeClass('bi-calendar-check').addClass('bi-calendar3-range');
            text.text(' So sánh năm');
          }
        });
      });

      // Initialize all charts
      function initCharts() {
        // Revenue trend chart
        revenueTrendChart = new ApexCharts(document.querySelector('#revenue-trend-chart'), {
          series: [],
          chart: {
            height: 400,
            type: 'bar',
            toolbar: {
              show: true,
              tools: {
                download: true,
                selection: false,
                zoom: false,
                zoomin: false,
                zoomout: false,
                pan: false,
                reset: false
              }
            },
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800,
              animateGradually: {
                enabled: true,
                delay: 150
              }
            }
          },
          colors: ['#007bff', '#28a745', '#ffc107'],
          plotOptions: {
            bar: {
              horizontal: false,
              columnWidth: '60%',
              borderRadius: 6,
              dataLabels: {
                position: 'top'
              }
            }
          },
          dataLabels: {
            enabled: true,
            formatter: val => formatChartAxisValue(val),
            offsetY: -20,
            style: {
              fontSize: '10px',
              colors: ['#304758'],
              fontWeight: 600
            }
          },
          stroke: {
            show: true,
            width: 2,
            colors: ['transparent']
          },
          xaxis: {
            categories: monthLabelsShort,
            labels: {
              style: {
                fontSize: '11px'
              }
            }
          },
          yaxis: {
            labels: {
              formatter: val => formatChartAxisValue(val),
              style: {
                fontSize: '11px'
              }
            }
          },
          fill: {
            opacity: 0.95
          },
          tooltip: {
            shared: true,
            intersect: false,
            y: {
              formatter: val => formatChartValue(val)
            }
          },
          legend: {
            position: 'top',
            fontSize: '13px',
            fontWeight: 600,
            markers: {
              width: 12,
              height: 12,
              radius: 3
            }
          },
          responsive: [{
            breakpoint: 768,
            options: {
              chart: {
                height: 300
              },
              dataLabels: {
                enabled: false
              },
              plotOptions: {
                bar: {
                  columnWidth: '80%'
                }
              }
            }
          }]
        });
        revenueTrendChart.render();

        // Distribution chart (Donut for overall, Bar for single location)
        distributionChart = new ApexCharts(document.querySelector('#revenue-distribution-chart'), {
          series: [],
          chart: {
            type: 'donut',
            height: 400,
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800,
              animateGradually: {
                enabled: true,
                delay: 150
              }
            }
          },
          labels: [],
          colors: ['#007bff', '#28a745', '#17a2b8', '#ffc107', '#6f42c1', '#fd7e14', '#20c997'],
          legend: {
            position: 'bottom',
            fontSize: '12px',
            markers: {
              width: 10,
              height: 10,
              radius: 2
            }
          },
          plotOptions: {
            pie: {
              donut: {
                size: '65%',
                labels: {
                  show: true,
                  name: {
                    fontSize: '14px',
                    fontWeight: 600
                  },
                  value: {
                    fontSize: '20px',
                    fontWeight: 700,
                    formatter: val => formatChartAxisValue(val)
                  },
                  total: {
                    show: true,
                    label: 'Tổng',
                    fontSize: '14px',
                    fontWeight: 600,
                    formatter: (w) => {
                      const total = sumArray(w.globals.seriesTotals);
                      return formatChartAxisValue(total, 2);
                    }
                  }
                }
              }
            }
          },
          tooltip: {
            y: {
              formatter: val => formatChartAxisValue(val, 2) + ' VNĐ'
            }
          },
          responsive: [{
            breakpoint: 768,
            options: {
              chart: {
                height: 320
              },
              legend: {
                position: 'bottom',
                fontSize: '11px'
              }
            }
          }]
        });
        distributionChart.render();

        // Revenue-Expense-Profit comparison chart
        revenueExpenseProfitChart = new ApexCharts(document.querySelector('#revenue-expense-profit-chart'), {
          series: [],
          chart: {
            type: 'bar',
            height: 350,
            toolbar: { show: false },
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800
            }
          },
          colors: ['#007bff', '#dc3545', '#28a745'],
          plotOptions: {
            bar: {
              horizontal: false,
              columnWidth: '60%',
              borderRadius: 6,
              dataLabels: { position: 'top' }
            }
          },
          dataLabels: {
            enabled: true,
            formatter: val => formatChartAxisValue(val),
            offsetY: -20,
            style: {
              fontSize: '10px',
              colors: ['#304758'],
              fontWeight: 600
            }
          },
          stroke: { show: true, width: 2, colors: ['transparent'] },
          xaxis: {
            categories: monthLabelsShort,
            labels: {
              style: {
                fontSize: '11px'
              }
            }
          },
          yaxis: {
            labels: {
              formatter: val => formatChartAxisValue(val),
              style: {
                fontSize: '11px'
              }
            }
          },
          fill: { opacity: 0.9 },
          tooltip: {
            shared: true,
            intersect: false,
            y: {
              formatter: val => formatChartValue(val)
            }
          },
          legend: {
            position: 'top',
            fontSize: '13px',
            fontWeight: 600
          },
          responsive: [{
            breakpoint: 768,
            options: {
              chart: {
                height: 300
              },
              dataLabels: {
                enabled: false
              },
              plotOptions: {
                bar: {
                  columnWidth: '80%'
                }
              }
            }
          }]
        });
        revenueExpenseProfitChart.render();

        // Profit margin chart
        profitMarginChart = new ApexCharts(document.querySelector('#profit-margin-chart'), {
          series: [{
            name: 'Biên lợi nhuận',
            data: []
          }],
          chart: {
            type: 'area',
            height: 350,
            toolbar: { show: false },
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800
            }
          },
          colors: ['#28a745'],
          stroke: {
            curve: 'smooth',
            width: 3
          },
          fill: {
            type: 'gradient',
            gradient: {
              shadeIntensity: 1,
              opacityFrom: 0.4,
              opacityTo: 0.1,
              stops: [0, 90, 100]
            }
          },
          markers: {
            size: 5,
            strokeWidth: 2,
            hover: {
              size: 7
            }
          },
          xaxis: {
            categories: monthLabelsShort,
            labels: {
              style: {
                fontSize: '11px'
              }
            }
          },
          yaxis: {
            labels: {
              formatter: val => val.toFixed(1) + '%',
              style: {
                fontSize: '11px'
              }
            }
          },
          annotations: {
            yaxis: [{
              y: 0,
              borderColor: '#999',
              strokeDashArray: 4,
              label: {
                borderColor: '#999',
                style: {
                  color: '#fff',
                  background: '#999'
                },
                text: 'Hòa vốn'
              }
            }]
          },
          tooltip: {
            y: {
              formatter: val => val.toFixed(2) + '%'
            }
          },
          grid: {
            borderColor: '#e7e7e7',
            row: {
              colors: ['#f3f3f3', 'transparent'],
              opacity: 0.5
            }
          },
          responsive: [{
            breakpoint: 768,
            options: {
              chart: {
                height: 280
              }
            }
          }]
        });
        profitMarginChart.render();
      }

      // Update dashboard based on selected location
      function updateDashboard() {
        updateKPIs();
        updateRevenueTrendChart();
        updateDistributionChart();
        updateRevenueExpenseProfitChart();
        updateProfitMarginChart();
        updateTable();
      }

      // Update KPI boxes
      function updateKPIs() {
        const currentMonth = getCurrentMonth();
        let data, title;

        if (currentLocation === '') {
          // All locations
          data = businessDataByMonth[2025];
          title = 'Tất cả cơ sở';
        } else {
          // Single location
          data = locationData[currentLocation];
          const loc = locations.find(l => l.id === currentLocation);
          title = loc.name;
        }

        // Calculate totals
        const monthlyRevenue = data.revenue[currentMonth];
        const yearlyRevenue = sumArray(data.revenue);
        const avgRevenue = yearlyRevenue / 12;

        // YoY growth
        const lastYearData = currentLocation === '' ? businessDataByMonth[2024] : null;
        let yoyGrowth = 0;
        if (lastYearData) {
          const lastYearRevenue = lastYearData.revenue[currentMonth];
          yoyGrowth = ((monthlyRevenue - lastYearRevenue) / lastYearRevenue * 100);
        } else {
          yoyGrowth = 13.6; // Default for single location
        }

        // Update KPIs
        $('#kpi-revenue').html(`
          ${formatChartAxisValue(monthlyRevenue, 2)}
          <small class="${yoyGrowth >= 0 ? 'trend-up' : 'trend-down'}">
            <i class="bi bi-arrow-${yoyGrowth >= 0 ? 'up' : 'down'}"></i> ${Math.abs(yoyGrowth).toFixed(1)}%
          </small>
        `);
        $('#kpi-yearly').text(formatChartAxisValue(yearlyRevenue, 2));
        $('#kpi-average').text(formatChartAxisValue(avgRevenue, 2));
        $('#kpi-yoy').html(`
          <small class="${yoyGrowth >= 0 ? 'trend-up' : 'trend-down'}">
            <i class="bi bi-arrow-${yoyGrowth >= 0 ? 'up' : 'down'}"></i> ${yoyGrowth >= 0 ? '+' : ''}${yoyGrowth.toFixed(1)}%
          </small>
        `);

        // Update chart title
        $('#chart-title').text(`Doanh thu theo tháng (${title})`);
      }

      // Update revenue trend chart
      function updateRevenueTrendChart() {
        let series = [];

        if (currentLocation === '') {
          // All locations - show comparison with previous years
          if (showYearComparison) {
            series = [
              { name: '2025', data: businessDataByMonth[2025].revenue },
              { name: '2024', data: businessDataByMonth[2024].revenue },
              { name: '2023', data: businessDataByMonth[2023].revenue }
            ];
          } else {
            series = [
              { name: '2025', data: businessDataByMonth[2025].revenue },
              { name: '2024', data: businessDataByMonth[2024].revenue }
            ];
          }
        } else {
          // Single location
          series = [
            { name: currentLocation, data: locationData[currentLocation].revenue }
          ];
        }

        revenueTrendChart.updateSeries(series);
      }

      // Update distribution chart
      function updateDistributionChart() {
        if (currentLocation === '') {
          // Show all locations distribution (yearly total)
          const locationTotals = locations.map(loc => {
            return getTotalRevenue(locationData, loc.id);
          });
          const labels = locations.map(loc => loc.name);

          distributionChart.updateOptions({
            chart: {
              type: 'donut',
              animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
              }
            },
            series: locationTotals,
            labels: labels,
            plotOptions: {
              pie: {
                donut: {
                  size: '65%',
                  labels: {
                    show: true,
                    name: {
                      fontSize: '14px',
                      fontWeight: 600
                    },
                    value: {
                      fontSize: '20px',
                      fontWeight: 700,
                      formatter: val => formatChartAxisValue(val)
                    },
                    total: {
                      show: true,
                      label: 'Tổng',
                      fontSize: '14px',
                      fontWeight: 600,
                      formatter: (w) => {
                        const total = sumArray(w.globals.seriesTotals);
                        return formatChartAxisValue(total, 2);
                      }
                    }
                  }
                }
              }
            }
          });
        } else {
          // Show monthly distribution for single location (as bar chart)
          const data = locationData[currentLocation].revenue;

          distributionChart.updateOptions({
            chart: {
              type: 'bar',
              animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
              }
            },
            series: [{
              name: 'Doanh thu',
              data: data
            }],
            labels: monthLabelsShort,
            plotOptions: {
              bar: {
                horizontal: false,
                columnWidth: '60%',
                borderRadius: 6,
                dataLabels: {
                  position: 'top'
                }
              }
            },
            dataLabels: {
              enabled: true,
              formatter: val => formatChartAxisValue(val),
              offsetY: -20,
              style: {
                fontSize: '10px',
                colors: ['#304758'],
                fontWeight: 600
              }
            },
            xaxis: {
              categories: monthLabelsShort,
              labels: {
                style: {
                  fontSize: '11px'
                }
              }
            },
            yaxis: {
              labels: {
                formatter: val => formatChartAxisValue(val),
                style: {
                  fontSize: '11px'
                }
              }
            }
          });
        }
      }

      // Update Revenue-Expense-Profit chart
      function updateRevenueExpenseProfitChart() {
        let data;

        if (currentLocation === '') {
          data = businessDataByMonth[2025];
        } else {
          data = locationData[currentLocation];
        }

        const series = [
          { name: 'Doanh thu', data: data.revenue },
          { name: 'Chi phí', data: data.expenses },
          { name: 'Lợi nhuận', data: data.profit }
        ];

        revenueExpenseProfitChart.updateSeries(series);
      }

      // Update Profit Margin chart
      function updateProfitMarginChart() {
        let data;

        if (currentLocation === '') {
          data = businessDataByMonth[2025];
        } else {
          data = locationData[currentLocation];
        }

        // Calculate profit margin for each month
        const profitMargins = data.revenue.map((rev, idx) => {
          return (data.profit[idx] / rev * 100);
        });

        profitMarginChart.updateSeries([{
          name: 'Biên lợi nhuận',
          data: profitMargins
        }]);
      }

      // Update table
      function updateTable() {
        const tableBody = $('#revenue-table-body');
        tableBody.empty();

        let data2025, data2024;

        if (currentLocation === '') {
          data2025 = businessDataByMonth[2025];
          data2024 = businessDataByMonth[2024];
        } else {
          data2025 = locationData[currentLocation];
          // For single location, we don't have 2024 data, so use estimate
          data2024 = {
            revenue: data2025.revenue.map(r => r * 0.952), // Assume ~5% growth from 2024
            expenses: data2025.expenses.map(e => e * 0.952),
            profit: data2025.profit.map(p => p * 0.952)
          };
        }

        // Iterate through months in reverse (December to January)
        for (let i = 11; i >= 0; i--) {
          const revenue = data2025.revenue[i];
          const expenses = data2025.expenses[i];
          const profit = data2025.profit[i];
          const profitMargin = ((profit / revenue) * 100);

          // Calculate YoY growth
          const revenueLastYear = data2024.revenue[i];
          const yoyGrowth = (((revenue - revenueLastYear) / revenueLastYear) * 100);

          // Determine status
          let status, statusClass;
          if (profit > 0 && yoyGrowth >= 10) {
            status = 'Xuất sắc';
            statusClass = 'success';
          } else if (profit > 0 && yoyGrowth >= 0) {
            status = 'Tốt';
            statusClass = 'info';
          } else if (profit > 0) {
            status = 'Trung bình';
            statusClass = 'warning';
          } else {
            status = 'Cần cải thiện';
            statusClass = 'danger';
          }

          const badgeClass = yoyGrowth >= 0 ? 'success' : 'danger';
          const growthSign = yoyGrowth >= 0 ? '+' : '';
          const profitClass = profit >= 0 ? 'text-success' : 'text-danger';

          const row = `
            <tr>
              <td><strong>Tháng ${i + 1}/2025</strong></td>
              <td class="text-right"><strong>${formatChartAxisValue(revenue, 2)}</strong></td>
              <td class="text-right">${formatChartAxisValue(expenses, 2)}</td>
              <td class="text-right ${profitClass}"><strong>${profit >= 0 ? formatChartAxisValue(profit, 2) : '(' + formatChartAxisValue(Math.abs(profit), 2) + ')'}</strong></td>
              <td class="text-center"><span class="badge badge-${profit >= 0 ? 'success' : 'danger'}">${profitMargin.toFixed(1)}%</span></td>
              <td class="text-center"><span class="badge badge-${badgeClass}">${growthSign}${yoyGrowth.toFixed(1)}%</span></td>
              <td class="text-center"><span class="badge badge-${statusClass}">${status}</span></td>
            </tr>
          `;

          tableBody.append(row);
        }
      }
    </script>
  </body>
</html>
